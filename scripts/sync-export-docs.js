#!/usr/bin/env node
/**
 * Sync export format docs from core/docs/exports/ into the Mintlify docs site.
 *
 * Usage (from mintlify-docs repo root):
 *   node scripts/sync-export-docs.js
 *   node scripts/sync-export-docs.js --regenerate   # run core's generate.py first
 *
 * Environment:
 *   CORE_DIR  Path to core repo (default: ../core relative to this script's repo root)
 *
 * Does:
 *   1. Optionally runs core's docs/exports/generate.py to refresh vuln_intel_format.md
 *   2. Copies vuln_intel_format.md and ioc_intel_format.md from core/docs/exports/
 *      into build/exports/ as .mdx with frontmatter; strips auto-generated HTML comments.
 */

const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");

const REPO_ROOT = path.resolve(__dirname, "..");
const CORE_DIR = process.env.CORE_DIR || path.resolve(REPO_ROOT, "..", "core");
const CORE_EXPORTS = path.join(CORE_DIR, "docs", "exports");
const OUT_DIR = path.join(REPO_ROOT, "build", "exports");

const FILES = [
  {
    src: "vuln_intel_format.md",
    out: "vuln-intel-format.mdx",
    title: "Vulnerability intelligence export format",
    description:
      "Schema and field reference for the vulnerability intelligence bulk export",
  },
  {
    src: "ioc_intel_format.md",
    out: "ioc-intel-format.mdx",
    title: "IOC intelligence export format",
    description:
      "Schema and field reference for the IOC (indicator of compromise) bulk export",
  },
];

function stripAutoGeneratedComments(content) {
  let out = content
    .replace(/^<!-- WARNING:.*?-->\s*\n/gi, "")
    .replace(/^<!-- Generated by:.*?-->\s*\n/gi, "")
    .replace(/^<!-- To update:.*?-->\s*\n/gi, "");
  // Remove the "AUTO-GENERATED DOCUMENTATION" warning line (may contain emoji)
  out = out
    .split("\n")
    .filter((line) => !line.includes("AUTO-GENERATED DOCUMENTATION"))
    .join("\n");
  return out;
}

function addFrontmatter(content, title, description) {
  const fm = `---
title: "${title}"
description: "${description}"
---

`;
  return fm + content.trimStart();
}

function main() {
  const regenerate = process.argv.includes("--regenerate");

  if (regenerate) {
    console.log("Regenerating export docs in core...");
    if (!fs.existsSync(path.join(CORE_DIR, "pyproject.toml"))) {
      console.error(
        "CORE_DIR is not the core repo root (no pyproject.toml). Set CORE_DIR.",
      );
      process.exit(1);
    }
    try {
      execSync(
        "pdm run python docs/exports/generate.py --output-dir docs/exports/",
        {
          cwd: CORE_DIR,
          stdio: "inherit",
        },
      );
    } catch (e) {
      console.error(
        "Core generate.py failed. Copying existing files if present.",
      );
    }
  }

  if (!fs.existsSync(CORE_EXPORTS)) {
    console.error(`Core exports dir not found: ${CORE_EXPORTS}`);
    console.error(
      "Set CORE_DIR or run from mintlify-docs with core at ../core",
    );
    process.exit(1);
  }

  fs.mkdirSync(OUT_DIR, { recursive: true });

  for (const { src, out, title, description } of FILES) {
    const srcPath = path.join(CORE_EXPORTS, src);
    const outPath = path.join(OUT_DIR, out);

    if (!fs.existsSync(srcPath)) {
      console.warn(`Skip (missing): ${src}`);
      continue;
    }

    let content = fs.readFileSync(srcPath, "utf8");
    content = stripAutoGeneratedComments(content);
    content = addFrontmatter(content, title, description);
    fs.writeFileSync(outPath, content, "utf8");
    console.log(`Wrote ${out}`);
  }

  console.log(
    "Done. Update docs.json nav to include build/exports/vuln-intel-format and build/exports/ioc-intel-format if needed.",
  );
}

main();
